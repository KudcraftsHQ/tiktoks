// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Carousel {
  id          String   @id @default(cuid())
  tiktokUrl   String   @unique
  title       String?
  description String?  // Caption/desc from TikTok
  author      String?  // Display name (nickname)
  authorHandle String? // Username (unique_id)
  authorAvatarId String? @db.Uuid // Cache asset ID reference
  tags        Json     @default("[]") // Array of hashtags with URLs

  // Engagement metrics
  viewCount    Int?     @default(0)
  likeCount    Int?     @default(0)
  shareCount   Int?     @default(0)
  saveCount    Int?     @default(0)
  commentCount Int?     @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  images      CarouselImage[]
  variations  CarouselVariation[]

  @@map("carousels")
}

model CarouselVariation {
  id          String   @id @default(cuid())
  carouselId  String
  name        String
  description String?
  isOriginal  Boolean  @default(false)
  generationType String? // 'manual', 'ai_rephrase', 'duplicate'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  carousel    Carousel @relation(fields: [carouselId], references: [id], onDelete: Cascade)
  slides      CarouselSlide[]
  
  @@map("carousel_variations")
  @@index([carouselId])
}

model CarouselSlide {
  id          String   @id @default(cuid())
  variationId String
  backgroundImageId String? @db.Uuid // Cache asset ID reference
  backgroundImagePositionX Float @default(0.5) // 0-1 for positioning
  backgroundImagePositionY Float @default(0.5) // 0-1 for positioning
  backgroundImageZoom Float @default(1.0) // zoom level
  displayOrder Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variation   CarouselVariation @relation(fields: [variationId], references: [id], onDelete: Cascade)
  textBoxes   CarouselTextBox[]

  @@map("carousel_slides")
  @@index([variationId])
}

model CarouselTextBox {
  id          String   @id @default(cuid())
  slideId     String
  text        String
  x           Float    // position x (0-1)
  y           Float    // position y (0-1)
  width       Float    // width (0-1)
  height      Float    // height (0-1)
  fontSize    Int      @default(24)
  fontFamily  String   @default("Poppins")
  fontWeight  String   @default("normal") // 'normal', 'bold'
  fontStyle   String   @default("normal") // 'normal', 'italic'
  textDecoration String @default("none") // 'none', 'underline'
  color       String   @default("#000000")
  textAlign   String   @default("center") // 'left', 'center', 'right'
  zIndex      Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  slide       CarouselSlide @relation(fields: [slideId], references: [id], onDelete: Cascade)
  
  @@map("carousel_text_boxes")
  @@index([slideId])
}

model CarouselImage {
  id          String   @id @default(cuid())
  carouselId  String
  imageId     String   @db.Uuid // Cache asset ID reference
  width       Int?
  height      Int?
  displayOrder Int
  text        String?  // OCR text content
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  carousel    Carousel @relation(fields: [carouselId], references: [id], onDelete: Cascade)

  @@map("carousel_images")
  @@index([carouselId])
  @@index([text])
}

// Cache Assets for media caching with background processing

model CacheAsset {
  id          String   @id @default(uuid()) @db.Uuid
  originalUrl String   @unique
  cacheKey    String?  // R2 storage key
  status      CacheStatus @default(PENDING)
  fileSize    Int?
  contentType String?
  cachedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cache_assets")
  @@index([status])
  @@index([originalUrl])
}

enum CacheStatus {
  PENDING
  DOWNLOADING
  CACHED
  FAILED
}

// New models for TikTok Profile Explorer

model TiktokProfile {
  id          String   @id @default(cuid())
  handle      String   @unique // TikTok username (unique_id)
  nickname    String?  // Display name
  avatarId    String?  @db.Uuid // Cache asset ID reference
  bio         String?  // Profile bio/description
  verified    Boolean  @default(false)
  followerCount Int?   @default(0)
  followingCount Int?  @default(0)
  videoCount  Int?     @default(0)
  likeCount   Int?     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       TiktokPost[]

  @@map("tiktok_profiles")
  @@index([handle])
}

model TiktokPost {
  id          String   @id @default(cuid())
  tiktokId    String   @unique // TikTok's aweme_id
  profileId   String
  tiktokUrl   String   @unique
  contentType String   // 'video' or 'photo'
  title       String?  // Generated or extracted title
  description String?  // Caption/desc from TikTok

  // Media cache asset ID references
  videoId     String?  @db.Uuid // Video cache asset ID reference
  coverId     String?  @db.Uuid // Cover cache asset ID reference
  musicId     String?  @db.Uuid // Music cache asset ID reference

  // Image carousel data (for photo posts)
  // Array of objects: [{"cacheAssetId": "uuid", "width": 100, "height": 200}]
  images      Json     @default("[]")

  // OCR and text extraction
  ocrTexts     Json     @default("[]") // Array of objects: [{"imageIndex": 0, "text": "extracted text"}]
  ocrStatus    String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  ocrProcessedAt DateTime?

  // Author info (denormalized for performance)
  authorNickname String?
  authorHandle   String?
  authorAvatarId String?  @db.Uuid // Author avatar cache asset ID reference

  // Hashtags and mentions
  hashtags    Json     @default("[]") // Array of hashtag objects
  mentions    Json     @default("[]") // Array of mentioned users

  // Engagement metrics
  viewCount    BigInt?  @default(0)
  likeCount    Int?     @default(0)
  shareCount   Int?     @default(0)
  commentCount Int?     @default(0)
  saveCount    Int?     @default(0)

  // Video specific metrics
  duration     Float?   // Video duration in seconds

  // Timestamps
  publishedAt  DateTime? // When the post was published on TikTok
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile      TiktokProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  collections  CollectionPost[]
  remixes      RemixPost[]

  @@map("tiktok_posts")
  @@index([profileId])
  @@index([contentType])
  @@index([publishedAt])
  @@index([authorHandle])
  @@index([ocrStatus])
}

model Collection {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  // Hex color for UI theming
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       CollectionPost[]

  @@map("collections")
}

model CollectionPost {
  id           String     @id @default(cuid())
  collectionId String
  postId       String
  addedAt      DateTime   @default(now())

  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  post         TiktokPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([collectionId, postId])
  @@map("collection_posts")
  @@index([collectionId])
  @@index([postId])
}

// Remix system for TikTok posts

model RemixPost {
  id              String   @id @default(cuid())
  originalPostId  String   // Reference to TikTokPost
  name            String
  description     String?
  generationType  String   @default("manual") // 'manual', 'ai_paraphrase'
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  originalPost    TiktokPost @relation(fields: [originalPostId], references: [id], onDelete: Cascade)
  slides          RemixSlide[]

  @@map("remix_posts")
  @@index([originalPostId])
}

model RemixSlide {
  id                        String @id @default(cuid())
  remixPostId               String
  originalImageId           String? @db.Uuid // Original image cache asset ID from TikTokPost
  backgroundImageId         String? @db.Uuid // Custom background cache asset ID
  displayOrder              Int

  // Image positioning (same as carousel)
  backgroundImagePositionX  Float @default(0.5) // 0-1 for positioning
  backgroundImagePositionY  Float @default(0.5) // 0-1 for positioning
  backgroundImageZoom       Float @default(1.0) // zoom level

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  remixPost                 RemixPost @relation(fields: [remixPostId], references: [id], onDelete: Cascade)
  textBoxes                 RemixTextBox[]

  @@map("remix_slides")
  @@index([remixPostId])
}

model RemixTextBox {
  id              String   @id @default(cuid())
  slideId         String
  text            String
  x               Float    // position x (0-1)
  y               Float    // position y (0-1)
  width           Float    // width (0-1)
  height          Float    // height (0-1)
  fontSize        Int      @default(24)
  fontFamily      String   @default("Poppins")
  fontWeight      String   @default("normal") // 'normal', 'bold'
  fontStyle       String   @default("normal") // 'normal', 'italic'
  textDecoration  String   @default("none") // 'none', 'underline'
  color           String   @default("#000000")
  textAlign       String   @default("center") // 'left', 'center', 'right'
  zIndex          Int      @default(1)
  textStroke      String?  // CSS text-stroke value
  textShadow      String?  // CSS text-shadow value
  borderWidth     Float?   // Border width in pixels
  borderColor     String?  // Border color
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  slide           RemixSlide @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@map("remix_text_boxes")
  @@index([slideId])
}

