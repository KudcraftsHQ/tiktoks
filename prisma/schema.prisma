// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  directUrl      = env("DATABASE_URL")
  url = env("DATABASE_URL_POOLING")
}

// Carousel models removed - migrated to RemixPost system

// Cache Assets for media caching with background processing

model CacheAsset {
  id          String   @id @default(uuid()) @db.Uuid
  originalUrl String   @unique
  cacheKey    String?  // R2 storage key
  status      CacheStatus @default(PENDING)
  fileSize    Int?
  contentType String?
  cachedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cache_assets")
  @@index([status])
  @@index([originalUrl])
}

enum CacheStatus {
  PENDING
  DOWNLOADING
  CACHED
  FAILED
}

// New models for TikTok Profile Explorer

model ProfileGroup {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  profiles    TiktokProfile[]

  @@map("profile_groups")
  @@index([name])
}

model TiktokProfile {
  id          String   @id @default(cuid())
  handle      String   @unique // TikTok username (unique_id)
  nickname    String?  // Display name
  avatarId    String?  @db.Uuid // Cache asset ID reference
  bio         String?  // Profile bio/description
  verified    Boolean  @default(false)

  // Group assignment
  profileGroupId String?
  profileGroup   ProfileGroup? @relation(fields: [profileGroupId], references: [id], onDelete: SetNull)

  // Deprecated - kept for backwards compatibility, not used
  followerCount Int?   @default(0)
  followingCount Int?  @default(0)
  videoCount  Int?     @default(0)
  likeCount   Int?     @default(0)

  // Aggregated metrics from posts (actually used)
  totalPosts      Int      @default(0)
  totalViews      BigInt   @default(0)
  totalLikes      BigInt   @default(0)
  totalShares     BigInt   @default(0)
  totalComments   BigInt   @default(0)
  totalSaves      BigInt   @default(0)

  // Monitoring fields
  monitoringEnabled Boolean  @default(false)
  lastMonitoringRun DateTime?
  nextMonitoringRun DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       TiktokPost[]
  monitoringLogs ProfileMonitoringLog[]

  @@map("tiktok_profiles")
  @@index([handle])
  @@index([monitoringEnabled, nextMonitoringRun])
  @@index([profileGroupId])
}

// Post Category for TikTok content classification

model PostCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  aiGenerated Boolean  @default(false) // Created by AI vs manually
  postCount   Int      @default(0) // How many posts use this category
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       TiktokPost[]

  @@map("post_categories")
  @@index([name])
  @@index([aiGenerated])
}

model TiktokPost {
  id          String   @id @default(cuid())
  tiktokId    String   @unique // TikTok's aweme_id
  profileId   String
  tiktokUrl   String   @unique
  contentType String   // 'video' or 'photo'
  title       String?  // Generated or extracted title
  description String?  // Caption/desc from TikTok

  // Media cache asset ID references
  videoId     String?  @db.Uuid // Video cache asset ID reference
  coverId     String?  @db.Uuid // Cover cache asset ID reference
  musicId     String?  @db.Uuid // Music cache asset ID reference

  // Music metadata
  musicTitle  String?  // Music title (e.g., "original sound - username")
  musicAuthor String?  // Music author/artist name

  // Image carousel data (for photo posts)
  // Array of objects: [{"cacheAssetId": "uuid", "width": 100, "height": 200}]
  images      Json     @default("[]")

  // Post category classification
  postCategoryId String?
  categoryConfidence Float?

  // OCR and text extraction - now includes full structured output
  // Full structure: { postCategory: {...}, slides: [...], processingMetadata: {...} }
  ocrData      Json     @default("{}") // Full structured OCR response
  ocrTexts     Json     @default("[]") // Denormalized: Array of objects: [{"imageIndex": 0, "text": "extracted text"}]
  imageDescriptions Json @default("[]") // Denormalized: Array of objects: [{"imageIndex": 0, "imageDescription": "detailed visual description"}]
  ocrStatus    String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  ocrProcessedAt DateTime?

  // Slide classifications - denormalized from ocrData
  // Array: [{slideIndex: 0, slideType: "hook", categoryId: "...", ...}]
  slideClassifications Json @default("[]")
  classificationStatus String @default("pending") // 'pending', 'processing', 'completed', 'failed'
  classificationProcessedAt DateTime?

  // Author info (denormalized for performance)
  authorNickname String?
  authorHandle   String?
  authorAvatarId String?  @db.Uuid // Author avatar cache asset ID reference

  // Hashtags and mentions
  hashtags    Json     @default("[]") // Array of hashtag objects
  mentions    Json     @default("[]") // Array of mentioned users

  // Engagement metrics
  viewCount    BigInt?  @default(0)
  likeCount    Int?     @default(0)
  shareCount   Int?     @default(0)
  commentCount Int?     @default(0)
  saveCount    Int?     @default(0)

  // Video specific metrics
  duration     Float?   // Video duration in seconds

  // Timestamps
  publishedAt  DateTime? // When the post was published on TikTok
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile      TiktokProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  postCategory PostCategory? @relation(fields: [postCategoryId], references: [id], onDelete: SetNull)
  projects     ProjectPost[]
  remixes      RemixPost[]
  metricsHistory TikTokPostMetricsHistory[]
  notifications Notification[]

  @@map("tiktok_posts")
  @@index([profileId])
  @@index([contentType])
  @@index([publishedAt])
  @@index([authorHandle])
  @@index([ocrStatus])
  @@index([postCategoryId])
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  // Hex color for UI theming
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       ProjectPost[]
  remixes     RemixPost[]

  @@map("projects")
}

model ProjectPost {
  id        String     @id @default(cuid())
  projectId String
  postId    String
  order     Int        @default(0) // Order of reference posts
  addedAt   DateTime   @default(now())

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  post      TiktokPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([projectId, postId])
  @@map("project_posts")
  @@index([projectId])
  @@index([postId])
}

// Draft Sessions for grouping generated content variations

model DraftSession {
  id                 String   @id @default(cuid())
  name               String   // User-editable session name

  // Generation configuration
  generationStrategy String   // 'remix' | 'inspired'
  languageStyle      String
  contentIdeas       String?
  slidesRange        Json     // { min: number, max: number }
  productContextId   String?  // Reference to ProductContext (optional)

  // Metadata
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  drafts             RemixPost[]
  productContext     ProductContext? @relation(fields: [productContextId], references: [id], onDelete: SetNull)

  @@map("draft_sessions")
  @@index([createdAt])
  @@index([productContextId])
}

// Remix system for TikTok posts - Simplified JSON structure

model RemixPost {
  id                 String   @id @default(cuid())
  originalPostId     String?  // Reference to TikTokPost (optional - can create remix without original)
  sourcePostIds      String[] @default([]) // NEW: Multiple source posts for multi-post generation
  productContextId   String?  // Reference to ProductContext (optional)
  sessionId          String?  // Reference to DraftSession (optional - groups related drafts)
  projectId          String?  // Reference to Project (optional - associates remix with project)
  name               String
  description        String?
  generationType     String   @default("manual") // 'manual', 'ai_paraphrase', 'ai_multi_post'
  additionalPrompt   String?  // Optional additional prompt used during paraphrasing
  generationPrompt   String?  // NEW: Full prompt used for generation
  languageStyleTags  String[] @default([]) // NEW: ["casual", "emoji-heavy", etc.]
  isDraft            Boolean  @default(true) // NEW: All new remixes start as drafts
  bookmarked         Boolean  @default(false) // Track if remix is bookmarked for content use
  approved           Boolean  @default(false) // Approval status for content use
  postedUrl          String?  // URL to posted TikTok content
  postedAt           DateTime? // When the remix was posted

  // Complete slide structure with canvas, backgrounds, and text boxes in JSON
  slides             Json     @default("[]") // Array of RemixSlide objects with full structure

  // NEW: Slide classifications stored alongside slides
  slideClassifications Json   @default("[]") // Array: [{slideIndex: 0, type: "HOOK", categoryId: "..."}]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  originalPost       TiktokPost? @relation(fields: [originalPostId], references: [id], onDelete: SetNull)
  productContext     ProductContext? @relation(fields: [productContextId], references: [id], onDelete: SetNull)
  session            DraftSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  project            Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  textStyles         RemixTextStyle[]
  classificationIndexes SlideClassificationIndex[]

  @@map("remix_posts")
  @@index([originalPostId])
  @@index([productContextId])
  @@index([sessionId])
  @@index([projectId])
  @@index([bookmarked])
  @@index([bookmarked, approved])
  @@index([postedUrl])
  @@index([isDraft])
  @@index([generationType])
}

// Text styles for Remix posts - reusable text styling templates

model RemixTextStyle {
  id              String   @id @default(cuid())
  remixId         String
  name            String
  isDefault       Boolean  @default(false) // Whether this is the default style for new text boxes
  
  // Text styling properties (matching RemixTextBoxType schema)
  fontSize        Int      @default(24)
  fontFamily      String   @default("Poppins")
  fontWeight      String   @default("normal")
  fontStyle       String   @default("normal")
  textDecoration  String   @default("none")
  color           String   @default("#000000")
  textAlign       String   @default("center")
  
  // Text effects
  enableShadow    Boolean  @default(false)
  shadowColor     String?
  shadowBlur      Int?
  shadowOffsetX   Int?
  shadowOffsetY   Int?
  outlineWidth    Int      @default(0)
  outlineColor    String?
  
  // Background styling
  backgroundColor String   @default("#ffffff")
  backgroundOpacity Float  @default(1)
  borderRadius    Int      @default(0)
  borderWidth     Int      @default(0)
  borderColor     String?
  
  // Padding and spacing
  paddingTop      Int      @default(8)
  paddingRight    Int      @default(12)
  paddingBottom   Int      @default(8)
  paddingLeft     Int      @default(12)
  lineHeight      Float    @default(1.2)
  letterSpacing   Int      @default(0)
  wordSpacing     Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  remix           RemixPost @relation(fields: [remixId], references: [id], onDelete: Cascade)
  
  @@map("remix_text_styles")
  @@index([remixId])
  @@index([remixId, isDefault])
}

// Global asset management - not tied to any specific remix

model AssetFolder {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assets      Asset[]

  @@map("asset_folders")
}

model Asset {
  id              String   @id @default(cuid())
  folderId        String?  // Optional folder
  cacheAssetId    String   @db.Uuid // Reference to CacheAsset
  name            String?  // Optional custom name
  width           Int?
  height          Int?
  sourceType      String?  // 'pinterest' | 'instagram' | null for manual uploads
  sourceUrl       String?  // Pinterest pin URL or Instagram post URL for deduplication
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  folder          AssetFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@map("assets")
  @@index([folderId])
  @@index([cacheAssetId])
  @@index([sourceUrl])
}

// Product Context for storing product information and prompts

model ProductContext {
  id          String   @id @default(cuid())
  title       String
  description String   // Prompt description for the product
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  remixes     RemixPost[]
  draftSessions DraftSession[]

  @@map("product_contexts")
  @@index([title])
}

// TikTok Post Metrics History for tracking engagement over time

model TikTokPostMetricsHistory {
  id           String   @id @default(cuid())
  postId       String
  viewCount    BigInt?
  likeCount    Int?
  shareCount   Int?
  commentCount Int?
  saveCount    Int?
  recordedAt   DateTime @default(now())

  post         TiktokPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("tiktok_post_metrics_history")
  @@index([postId, recordedAt])
}

// Profile Monitoring Logs for tracking monitoring execution

model ProfileMonitoringLog {
  id            String    @id @default(cuid())
  profileId     String
  status        String    // 'pending', 'running', 'completed', 'failed'
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  postsScraped  Int?
  pagesScraped  Int?
  error         String?

  profile       TiktokProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("profile_monitoring_logs")
  @@index([profileId, startedAt])
  @@index([status])
}

// AI Conversations for chat with data feature

model Conversation {
  id               String   @id @default(cuid())
  title            String?
  selectedPostIds  String[]
  messages         Json     // Array of Message objects
  currentModel     String   @default("gemini-2.5-flash")
  totalInputTokens  Int     @default(0)
  totalOutputTokens Int     @default(0)
  totalCost        Float    @default(0.0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("conversations")
  @@index([updatedAt])
}

// Content Ideation System - Categories for slide classification

model ContentIdeaCategory {
  id          String   @id @default(cuid())
  name        String
  type        String   // "HOOK" | "CONTENT" | "CTA"
  description String?
  aiGenerated Boolean  @default(false)
  slideCount  Int      @default(0) // How many slides use this category
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  classifications SlideClassificationIndex[]

  @@map("content_idea_categories")
  @@index([type])
  @@index([aiGenerated])
  @@unique([name, type])
}

// Content Ideation System - Searchable index of classified slides

model SlideClassificationIndex {
  id                String   @id @default(cuid())
  remixPostId       String
  slideIndex        Int
  type              String   // "HOOK" | "CONTENT" | "CTA"
  categoryId        String
  contentText       String   @db.Text // Denormalized for search
  sourcePostId      String?  // Original TikTokPost if exists
  languageStyleTags String[] @default([])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  remixPost         RemixPost @relation(fields: [remixPostId], references: [id], onDelete: Cascade)
  category          ContentIdeaCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("slide_classification_index")
  @@index([type, categoryId])
  @@index([sourcePostId])
  @@index([remixPostId, slideIndex])
  @@unique([remixPostId, slideIndex])
}

// TikTok Upload Accounts for OAuth-connected accounts used as upload destinations

model TiktokUploadAccount {
  id                  String   @id @default(cuid())

  // TikTok user info
  openId              String   @unique // TikTok's unique user identifier
  username            String?  // TikTok username/handle
  displayName         String?  // User's display name
  avatarUrl           String?  // Profile avatar URL

  // OAuth tokens
  accessToken         String   // OAuth access token
  refreshToken        String   // OAuth refresh token
  tokenExpiresAt      DateTime // When access token expires
  refreshExpiresAt    DateTime // When refresh token expires

  // Authorization scope
  scope               String   // Granted scopes (e.g., "video.upload,video.publish")

  // Account status
  status              TiktokAccountStatus @default(ACTIVE)

  // Timestamps
  connectedAt         DateTime @default(now())
  lastUsedAt          DateTime?
  updatedAt           DateTime @updatedAt

  @@map("tiktok_upload_accounts")
  @@index([openId])
  @@index([status])
}

enum TiktokAccountStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

// Notification system for tracking events and alerts

model Notification {
  id        String   @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  read      Boolean  @default(false)
  postId    String?
  post      TiktokPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  metadata  Json?    // Flexible field for additional data
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notifications")
  @@index([read, createdAt])
  @@index([postId, type])
}

enum NotificationType {
  HIGH_VIEWS          // >= 1000 views
  VIRAL_CONTENT       // Future: very high engagement
  LOW_PERFORMANCE     // Future: content not performing well
  NEW_POST            // Future: new post detected
}

